# Stage 1
FROM php:7.3-apache AS builder

MAINTAINER DevEkode

# Install and execute final steps
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y git zip unzip nodejs npm

RUN curl --silent --show-error https://getcomposer.org/installer | php

COPY ./composer.json /app/composer.json
COPY ./package.json /app/package.json

RUN cd /app \
    && /var/www/html/composer.phar install \
    && npm install

# Stage 2
FROM php:7.3-apache AS base

# Configure PHP
RUN docker-php-ext-install mysqli

RUN yes | pecl install xdebug \
    && echo "zend_extension=$(find /usr/local/lib/php/extensions/ -name xdebug.so)" > /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_enable=on" >> /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_autostart=off" >> /usr/local/etc/php/conf.d/xdebug.ini

# Stage 3
FROM base AS app

COPY . /app
COPY .docker/apache/vhost.conf /etc/apache2/sites-available/000-default.conf

COPY --from=builder /app/node_modules /app/node_modules
COPY --from=builder /app/vendor /app/vendor

RUN a2enmod rewrite

RUN chown -R www-data:www-data /app


