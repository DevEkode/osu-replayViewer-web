<?php
  require 'php/view/functions.php';
  require 'php/osuApiFunctions.php';
  require 'secure/osu_api_key.php';

  $replayDATA = getReplayArray($_GET['id']);

  //Check if the replay exist
  if(empty($replayDATA)){
    header("Location:index.html");
  }

  $userJSON = getUserJSON($replayDATA['userId'],$osuApiKey);

  $urlRaw = "/replayList/".$_GET['id']."/".$_GET['id'].".mp4";
  if(file_exists($urlRaw)){
    $showRaw = true;
  }else{
    $showRaw = false;
  }

  $osrUrl = "/replayList/".$_GET['id']."/".rawurlencode($replayDATA['OFN']);
  if(file_exists($osrUrl)){
    $showOsr = true;
  }else{
    $showOsr = false;
  }
?>

<!DOCTYPE html>
<html>

  <head>
    <!-- Discord metadata -->
    <meta content="osu!replayViewer - osu replays sharing" property="og:title">
    <meta content="Share your osu! performance to everyone !" property="og:description">
    <meta content="osu!replayViewer" property="og:site_name">
    <meta content="http://osureplayviewer.xyz/images/icon.png" property='og:image'>

    <title>osu!replayViewer - View replay</title>
    <link rel="icon" type="image/png" href="images/icon.png" />

    <link rel="stylesheet" type="text/css" href="css/navbar.css">
    <link rel="stylesheet" type="text/css" href="css/footer.css">
    <link rel="stylesheet" type="text/css" href="css/view.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Cookie bar -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/cookie-bar/cookiebar-latest.min.js?theme=flying&tracking=1&always=1&scrolling=1"></script>
  </head>

  <body>
    <!-- navigation bar -->
    <div class="top-nav">
      <div class="floatleft">
        <a href="search.php" class="nav-link">
          <i class="material-icons">search</i> Search</a>
        <a href="#news" class="nav-link">
          <i class="material-icons">question_answer</i> FAQ</a>
      </div>

      <a href="#" id="logo">
        <img src="images/icon.png" />
      </a>

      <div class="floatright">
        <a href="#news" class="nav-link">
          <i class="material-icons">how_to_reg</i> Register</a>
        <a href="#news" class="nav-link">
          <i class="material-icons">vpn_key</i> Login</a>
      </div>
    </div>

    <!-- Video -->
    <h1 id="title"><?php
      $BFN = base64_decode($replayDATA['BFN']);
      $BFN = str_replace(".osz",'', $BFN);
      $BFN = str_replace($replayDATA['beatmapSetId'],'', $BFN);
      echo $BFN;
    ?></h1>
    <h1 id="subtitle"><?php echo $userJSON[0]['username']; ?></h1>

    <div class="first_block">

      <?php
        if(empty($replayDATA['youtubeId'])){
          echo '<video class="video" poster="" controls>';
    			echo "<source src=$urlRaw  type='video/mp4'>";
    			echo '</video>';
        }else{
          echo "<iframe class=\"video\" src=".generateYoutubeLink($replayDATA['youtubeId'])." frameborder=\"1\" allow=\"autoplay; encrypted-media\" allowfullscreen></iframe>";
        }
      ?>
      <!-- Right content block -->
      <div class="right_content">
        <span id="section_title">Visit <?php echo $userJSON[0]['username']; ?> profiles</span>
        <!-- <img id="beatmap_image" src=<?php echo '"'.'https://b.ppy.sh/thumb/'.$replayDATA['beatmapSetId']."l.jpg".'"'; ?> /> -->
        <br>

        <?php generateAccountBlock($replayDATA['userId'],$userJSON[0]['username']); ?>

        <span id="section_title">Mods</span>
        <?php drawMod($replayDATA['binaryMods']);   ?>

        <span id="section_title">Downloads</span>
        <div id="download_section">
          <?php
            if($showRaw){
              echo "<a href=$urlRaw><img src=\"images/view/video_source.png\"/></a>";
            }

            if($showOsr){
              echo "<a href=$osrUrl><img src=\"images/view/download_replay.png\"/></a>";
            }
          ?>
          <!-- <a href="#"><img src="images/view/download_skin.png"/> -->
        </div>
      </div>
    </div>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>

    <!-- Footer -->
    <footer>
      <h3 class="align_center">osu!replayViewer is not affiliated with osu! - All credit to Dean Herbert</h3>
      <div class="footer_img">
        <a href="https://discord.gg/pqvhvxx" title="join us on discord!" target="_blank">
          <img src="images/index/discord_logo.png"/>
        </a>
        <a href="https://osu.ppy.sh/community/forums/topics/697883" target="_blank">
          <img src="images/index/osu forums.png"/>
        </a>
        <a href="https://github.com/codevirtuel/osu-replayViewer-web" target="_blank">
          <img src="images/index/github_logo.png"/>
        </a>
        <a href="https://paypal.me/codevirtuel" target="_blank">
          <img src="images/index/paypal_me.png"/>
        </a>
      </div>

      <div id="created">
        <span> website created by codevirtuel <a href="https://osu.ppy.sh/u/3481725" target="_blank"><img src="images/codevirtuel.jpg"/></a></span>
      </div>
    </footer>
  </body>

</html>
